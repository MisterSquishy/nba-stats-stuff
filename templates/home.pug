div(class="main container-fluid text-center")
    div(class="choicesdiv")
      select(id="teamselect" class="form-control")
        option(value="All") Full NBA
        option(value="DavidsTheYounger") Davids The Younger
        option(value="DavidsTheWiser") Davids The Wiser
      select(id="dateselect" class="form-control")
        option(value="FullSeason") Full Season
        option(value="Today") Today
        option(value="Yesterday") Yesterday
      select(id="pointselect" class="form-control")
        option(value="Real") Real stats
        option(value="Fantasy") Fantasy points
    div(class="headerdiv")
      h1 NBA Stats
    div(class="tablediv")
      table(id="statstable" class="display" width="100%")
    div(class="notesdiv" style="text-align:right;")
      h4 *does not reflect actual fantasy points recorded by starting lineups
script(src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript")
link(href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css")
script(src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js" type="text/javascript")
script.
  window.onload = function() {
    var headers = JSON.parse("#{headers}".replace(/&quot;/g,'"'));
    var fullResults = JSON.parse("#{rowSet}".replace(/&quot;/g,'"'));
    var teamRosters = JSON.parse("#{teamRosters}".replace(/&quot;/g,'"'));
    var scoringMap = JSON.parse("#{fantasyScoring}".replace(/&quot;/g,'"'));
    var filteredResults = fullResults;
    var hasFooter = false;
    var footerCallback = function (row, data, start, end, display) {
      var api = this.api(), data;

      // Remove the formatting to get integer data for summation
      var intVal = function (i) {
          return typeof i === 'string' ?
              i.replace(/[\$,]/g, '') * 1 :
              typeof i === 'number' ?
              i : 0;
      };

      //create footer (surely there's a saner way to do this)
      if (!hasFooter) {
        var footerHTML = '<tfoot><tr>';
        this.api().columns().every(function () {
            footerHTML += '<td style="padding: 10px 18px 6px 10px;"/>';
        });
        $(this).append(footerHTML + '</tr></tfoot>');
        hasFooter = true;
      }

      // Total over this page
      for (var i in headers) {
        if (headers[i].title.endsWith('%')) {
          num = api
              .column( i-2 )
              .data()
              .reduce(function (a, b) {
                  return intVal(a) + intVal(b);
              }, 0);
          denom = api
              .column( i-1 )
              .data()
              .reduce(function (a, b) {
                  return intVal(a) + intVal(b);
              }, 0);
          pageTotal = Math.round(num/denom*1000)/10;
        }
        else {
          pageTotal = Math.round(api
              .column( i )
              .data()
              .reduce(function (a, b) {
                  return intVal(a) + intVal(b);
              }, 0)*10)/10;
        }

        // Update footer
        if (i === "0") {
          $(api.column( i ).footer()).html('Totals:');
        }
        else if (parseFloat(i) === (headers.length - 1)) {
          $(api.column( i ).footer()).html(pageTotal + '*');
        }
        else {
          $(api.column( i ).footer()).html(pageTotal);
        }
      }
    };
    var table = $('#statstable').DataTable( {
      pageLength: 50,
      columns: headers,
      data: filteredResults,
      footerCallback: footerCallback,
      order: [[headers.length - 1, "desc"]]
    });
    $('#teamselect').change(function() {
      filteredResults = [];
      var roster = teamRosters[$("option:selected", this)[0].value];
      if (roster) {
        for (var i in fullResults) {
          if (roster.includes(fullResults[i][0])) {
            filteredResults.push(fullResults[i]);
          }
        }
      }
      else {
        filteredResults = fullResults;
      }
      table.destroy(); //can't i just redraw the dang thing??
      table = $('#statstable').DataTable( {
        pageLength: 50,
        columns: headers,
        data: filteredResults,
        footerCallback: footerCallback,
      });
    });
    $('#pointselect').change(function() {
      var opt = $("option:selected", this)[0].value;
      var displayResults = [];
      if (opt === 'Real') {
        displayResults = filteredResults;
        for (var col in table.columns) {
          //show the original column set
          //table.column(col).visible(true);
        }
      }
      else if (opt === 'Fantasy') {
        for (var row in filteredResults) {
          displayRow = [];
          displayHeaders = [];
          for (var col in filteredResults[row]) {
            if (isNaN(parseFloat(filteredResults[row][col])) || col == (headers.length - 1)) {
              displayRow.push(filteredResults[row][col]);
              table.column(col).visible(true);
            }
            else if (scoringMap.hasOwnProperty(headers[col].title)) {
              displayRow.push(filteredResults[row][col] * scoringMap[headers[col].title]);
              table.column(col).visible(true);
            }
            else if (headers[col].title === 'FGMi') { //hack city
              displayRow.push(filteredResults[row][col]);
              table.column(col).visible(true);
            }
            else {
              displayRow.push(filteredResults[row][col]);
              table.column(col).visible(false);
            }
          }
          displayResults.push(displayRow);
        }
      }
      for (var col in table.columns()) {
        console.log(table.column(col).visible());
      }
      table.destroy(); //can't i just redraw the dang thing??
      table = $('#statstable').DataTable( {
        pageLength: 50,
        columns: headers,
        data: displayResults,
        footerCallback: footerCallback,
      });
    });
  };
